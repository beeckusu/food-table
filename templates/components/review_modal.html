<!-- Review Modal -->
{% if user.is_staff %}
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div class="w-100">
                    <h5 class="modal-title" id="reviewModalLabel">Create New Review</h5>
                    <div class="progress mt-2" style="height: 4px;">
                        <div class="progress-bar" id="reviewProgressBar" role="progressbar" style="width: 20%;" aria-valuenow="20" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small class="text-muted" id="reviewStepIndicator">Step 1 of 5</small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Basic Information -->
                <div id="step-basic-info" class="review-step" data-step="1">
                    <h6 class="mb-3">Basic Information</h6>
                    <form id="basicInfoForm">
                        <div class="mb-3">
                            <label for="reviewRestaurantName" class="form-label">Restaurant Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="reviewRestaurantName" required autocomplete="off">
                            <div id="restaurantSearchResults" class="list-group mt-2" style="display: none;"></div>
                            <div id="restaurantSearchStatus" class="form-text"></div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewVisitDate" class="form-label">Visit Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="reviewVisitDate" required>
                            <div class="form-text">Date must not be in the future</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="reviewPartySize" class="form-label">Party Size</label>
                                <input type="number" class="form-control" id="reviewPartySize" min="1" value="1">
                                <div class="form-text">Number of people</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reviewEntryTime" class="form-label">Time</label>
                                <input type="time" class="form-control" id="reviewEntryTime">
                                <div class="form-text">Optional</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewMealType" class="form-label">Meal Type</label>
                            <select class="form-select" id="reviewMealType">
                                <option value="">Select meal type...</option>
                                <option value="breakfast">Breakfast</option>
                                <option value="brunch">Brunch</option>
                                <option value="lunch">Lunch</option>
                                <option value="dinner">Dinner</option>
                                <option value="snack">Snack</option>
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Location -->
                <div id="step-location" class="review-step" data-step="2" style="display: none;">
                    <h6 class="mb-3">Location <span class="badge bg-secondary">Optional</span></h6>
                    <form id="locationForm">
                        <div class="mb-3">
                            <label for="reviewAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="reviewAddress" placeholder="Street address">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="reviewCity" class="form-label">City</label>
                                <input type="text" class="form-control" id="reviewCity">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="reviewCountry" class="form-label">Country</label>
                                <input type="text" class="form-control" id="reviewCountry">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewNeighborhood" class="form-label">Neighborhood/Area</label>
                            <input type="text" class="form-control" id="reviewNeighborhood">
                        </div>
                    </form>
                </div>

                <!-- Step 3: Rating & Notes -->
                <div id="step-rating" class="review-step" data-step="3" style="display: none;">
                    <h6 class="mb-3">Rating & Notes</h6>
                    <form id="ratingForm">
                        <div class="mb-3">
                            <label for="reviewOverallRating" class="form-label">Overall Rating <span class="text-danger">*</span></label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" class="form-range flex-grow-1" id="reviewOverallRating" min="0" max="100" value="50" required>
                                <span class="badge bg-primary" id="ratingValue" style="min-width: 50px;">50</span>
                            </div>
                            <div class="form-text">Rate from 0-100</div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewTitle" class="form-label">Review Title</label>
                            <input type="text" class="form-control" id="reviewTitle" maxlength="200" placeholder="Optional title for your review">
                            <div class="form-text">
                                <span id="titleCharCount">0</span>/200 characters
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewNotes" class="form-label">Notes/Comments</label>
                            <textarea class="form-control" id="reviewNotes" rows="5" placeholder="Share your thoughts about the experience..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="reviewAmbiance" class="form-label">Ambiance Rating</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" class="form-range flex-grow-1" id="reviewAmbiance" min="0" max="100" value="50">
                                <span class="badge bg-secondary" id="ambianceValue" style="min-width: 50px;">50</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="reviewService" class="form-label">Service Rating</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="range" class="form-range flex-grow-1" id="reviewService" min="0" max="100" value="50">
                                <span class="badge bg-secondary" id="serviceValue" style="min-width: 50px;">50</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Step 4: Dishes -->
                <div id="step-dishes" class="review-step" data-step="4" style="display: none;">
                    <h6 class="mb-3">Dishes</h6>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Add dishes you tried during your visit. You can add multiple dishes.
                    </div>
                    <div id="dishesContainer">
                        <!-- Dishes will be added here dynamically -->
                    </div>
                    <button type="button" class="btn btn-outline-primary" id="addDishBtn">
                        <i class="bi bi-plus-circle"></i> Add Dish
                    </button>
                    <div id="dishFormTemplate" style="display: none;">
                        <div class="card mb-3 dish-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <h6 class="mb-0">Dish <span class="dish-number"></span></h6>
                                        <div class="btn-group btn-group-sm dish-reorder-buttons" role="group">
                                            <button type="button" class="btn btn-outline-secondary move-up-btn" title="Move up">
                                                <i class="bi bi-arrow-up"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary move-down-btn" title="Move down">
                                                <i class="bi bi-arrow-down"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-dish-btn">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Dish Name <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control dish-name" required autocomplete="off">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Encyclopedia Links <span class="badge bg-secondary">Optional</span></label>
                                    <button type="button" class="btn btn-sm btn-outline-primary link-encyclopedia-btn">
                                        <i class="bi bi-book"></i> Link to Encyclopedia
                                    </button>
                                    <div class="encyclopedia-chips mt-2" style="display: none;">
                                        <div class="d-flex flex-wrap gap-2"></div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Rating <span class="text-danger">*</span></label>
                                    <div class="d-flex align-items-center gap-3">
                                        <input type="range" class="form-range flex-grow-1 dish-rating" min="0" max="100" value="50" required>
                                        <span class="badge bg-primary dish-rating-value" style="min-width: 50px;">50</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Image <span class="badge bg-secondary">Optional</span></label>
                                    <div class="dish-image-upload-container">
                                        <div class="dish-image-drop-zone">
                                            <input type="file" class="form-control dish-image" accept="image/jpeg,image/png,image/webp">
                                            <div class="drop-zone-text">
                                                <i class="bi bi-cloud-upload"></i>
                                                <p class="mb-0">Click to select or drag & drop an image</p>
                                                <small class="text-muted">JPEG, PNG, WebP (max 10MB)</small>
                                            </div>
                                        </div>
                                        <div class="dish-image-preview" style="display: none;">
                                            <img src="" alt="Dish preview" class="dish-preview-img">
                                            <button type="button" class="btn btn-sm btn-outline-danger remove-image-btn">
                                                <i class="bi bi-x-circle"></i> Remove Image
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notes <span class="badge bg-secondary">Optional</span></label>
                                    <textarea class="form-control dish-notes" rows="2" placeholder="Optional notes about this dish..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Review & Confirm -->
                <div id="step-confirm" class="review-step" data-step="5" style="display: none;">
                    <h6 class="mb-3">Review & Confirm</h6>
                    <div class="alert alert-secondary">
                        <i class="bi bi-eye"></i> Please review your information before submitting
                    </div>
                    <div id="reviewSummary">
                        <!-- Summary will be populated here -->
                    </div>
                </div>

                <div id="reviewFormError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="reviewCancelBtn">Cancel</button>
                <button type="button" class="btn btn-outline-secondary" id="reviewBackBtn" style="display: none;">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
                <button type="button" class="btn btn-outline-primary" id="reviewSkipBtn" style="display: none;">
                    Skip <i class="bi bi-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-primary" id="reviewNextBtn">
                    Next <i class="bi bi-arrow-right"></i>
                </button>
                <button type="button" class="btn btn-success" id="reviewSubmitBtn" style="display: none;">
                    <i class="bi bi-check-circle"></i> Submit Review
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Encyclopedia Search Modal (nested within review flow) -->
<div class="modal fade" id="reviewEncyclopediaSearchModal" tabindex="-1" aria-labelledby="reviewEncyclopediaSearchLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reviewEncyclopediaSearchLabel">
                    <i class="bi bi-book"></i> Link to Encyclopedia
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="reviewEncyclopediaSearch" class="form-label">Search Encyclopedia Entries</label>
                    <input type="text" class="form-control" id="reviewEncyclopediaSearch"
                           placeholder="Type to search..." autocomplete="off">
                    <div class="form-text">Search by name, cuisine type, or category</div>
                </div>
                <div id="reviewEncyclopediaSearchStatus" class="text-muted mb-2" style="display: none;"></div>
                <div id="reviewEncyclopediaSearchResults" class="list-group" style="max-height: 400px; overflow-y: auto;">
                    <!-- Search results will appear here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Done</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
